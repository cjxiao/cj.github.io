<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="CJ&#39;s SpaceX">
<meta property="og:url" content="http://hiack.com/index.html">
<meta property="og:site_name" content="CJ&#39;s SpaceX">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CJ&#39;s SpaceX">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://hiack.com/"/>





  <title>CJ's SpaceX</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">CJ's SpaceX</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://hiack.com/2018/01/31/201801/audience_geo_analysis_using_spark_postgis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CJ's SpaceX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/31/201801/audience_geo_analysis_using_spark_postgis/" itemprop="url">Audience Geo Analysis using Spark + PostGIS</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-31T15:52:23+08:00">
                2018-01-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/spark/" itemprop="url" rel="index">
                    <span itemprop="name">Spark</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/spark/postgis/" itemprop="url" rel="index">
                    <span itemprop="name">PostGIS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h1><p>Recently I’m working on a project to analyze the DeviceID/GPS carried in each Ad Request, to gain some insights in the <strong>audience geographic characteristics</strong>.</p>
<p>So, the <strong>Input Data</strong> is:</p>
<ol>
<li>Ad Request log on AWS S3, and each Ad Request contains (optionally): timestamp, device type/id, lat/lng, source app, etc.</li>
<li>POI (Place of Interest) data in PostGIS (with polygon, or just a LatLng point), e.g., Residential Neighborhood data in Shanghai.</li>
</ol>
<p>The <strong>Result Output</strong> is:</p>
<ul>
<li>Count/frequency of users from specific source POIs/Brands/Categories visiting specific destination ones.</li>
<li>maybe more…</li>
</ul>
<p>The <strong>platform and tools</strong> I’m using include:</p>
<ul>
<li><strong>AWS EC2 &amp; S3</strong></li>
<li><strong>SparkSQL + Scala</strong></li>
<li><strong>PostgreSQL + PostGIS extension</strong></li>
</ul>
<h1 id="Lessons-amp-Notes"><a href="#Lessons-amp-Notes" class="headerlink" title="Lessons &amp; Notes"></a>Lessons &amp; Notes</h1><p>After two weeks hard-working, I’m about to finish the project.<br>Just some lessons and notes I want to put down here:</p>
<h2 id="AWS-S3"><a href="#AWS-S3" class="headerlink" title="AWS S3"></a>AWS S3</h2><p>It turns out to be a <a href="http://hiack.com/2018/01/27/201801/bad-idea-using-spark-with-s3-md/">Bad Idea Using SparkSQL with S3</a>.<br>And some configurations must be paid attention to, to <a href="http://hiack.com/2018/01/10/201801/enable_spark_on_ec2_accessing_s3/">Enable Spark on AWS EC2 Accessing AWS S3</a>.</p>
<h2 id="SQL-amp-PostGIS"><a href="#SQL-amp-PostGIS" class="headerlink" title="SQL &amp; PostGIS"></a>SQL &amp; PostGIS</h2><h3 id="Plain-SQL"><a href="#Plain-SQL" class="headerlink" title="Plain SQL"></a>Plain SQL</h3><p>I choose to use PostGIS, as I need to perform some geo operations like <code>ST_DWithin, ST_Contains, ST_Distance</code>.</p>
<p>There’s a <a href="https://github.com/tminglei/slick-pg" target="_blank" rel="noopener">Slick extensions for PostgreSQL</a> available, which supports PostGIS operators in Scala.<br>Still, I decided to use <code>Plain SQL</code>, as it’s</p>
<ul>
<li>More popular (on StackOverflow)</li>
<li>Easier to learn, and deubgging (by PostgreSQL CLI)</li>
</ul>
<h3 id="DB-Connections-in-Spark-RDD"><a href="#DB-Connections-in-Spark-RDD" class="headerlink" title="DB Connections in Spark RDD"></a>DB Connections in Spark RDD</h3><p>As you may have known of,</p>
<ul>
<li>We <strong>must not</strong> create DB connections out of an RDD and use them inside.</li>
<li>And we don’t want to setup DB connections for every record, which is <strong>inefficient</strong>.</li>
</ul>
<p>So, we’d better follow the <a href="https://spark.apache.org/docs/latest/streaming-programming-guide.html#design-patterns-for-using-foreachrdd" target="_blank" rel="noopener">Design Patterns for using foreachRDD</a>, just that I used <code>Dataset[T]::mapPartitions</code> instead.</p>
<h3 id="Spark-Lazy-Evaluation"><a href="#Spark-Lazy-Evaluation" class="headerlink" title="Spark Lazy Evaluation"></a>Spark Lazy Evaluation</h3><p>If you follow the design patterns above, you may find your Spark application fails to run due to DB connection issue (like not connected, or invalid statement).<br>That’s why you need the <code>.toList</code> operations as shown below:<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> res = partitionOfRecords.flatMap &#123; rec =&gt;</span><br><span class="line">    ???</span><br><span class="line">&#125;.toList <span class="comment">// toList: force eager computation</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Alternative-to-PostGIS"><a href="#Alternative-to-PostGIS" class="headerlink" title="Alternative to PostGIS"></a>Alternative to PostGIS</h3><p>If you:</p>
<ul>
<li>Just need to calculate the geographic distance between 2 Poins (no polygon),</li>
<li>And you can tolerate losing some precision (for the specific cases below, ~0.001%)</li>
</ul>
<p>Then, you can just pass PostGIS, as show below.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">poi=# SELECT ST_distance(ST_GeomFromText('POINT(121.337293282 31.1672401193)', 4326)::geography, ST_GeomFromText('POINT(121.366448159 31.2103586192)', 4326)::geography);</span><br><span class="line">  st_distance</span><br><span class="line"><span class="comment">---------------</span></span><br><span class="line"> 5529.65840066</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">poi=# SELECT ST_distance(ST_GeomFromText('POINT(121.337293282 31.1672401193)')::geography, ST_GeomFromText('POINT(121.337393282 31.1673401193)')::geography);</span><br><span class="line"> st_distance</span><br><span class="line"><span class="comment">-------------</span></span><br><span class="line"> 14.62253234</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; :paste</span><br><span class="line"><span class="comment">// Entering paste mode (ctrl-D to finish)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">calDistanceM</span></span>(lon1: <span class="type">Double</span>, lat1: <span class="type">Double</span>, lon2: <span class="type">Double</span>, lat2: <span class="type">Double</span>): <span class="type">Double</span> =&#123;</span><br><span class="line">    <span class="comment">//pi为π，r为地球半径</span></span><br><span class="line">    <span class="keyword">val</span> pi = <span class="number">3.1415926</span></span><br><span class="line">    <span class="keyword">val</span> r: <span class="type">Double</span>  = <span class="number">6370.99681</span></span><br><span class="line">    <span class="comment">//a1、a2、b1、b2分别为上面数据的经纬度转换为弧度</span></span><br><span class="line">    <span class="keyword">val</span> a1 = lat1 * pi /<span class="number">180.0</span></span><br><span class="line">    <span class="keyword">val</span> a2 = lon1 * pi /<span class="number">180.0</span></span><br><span class="line">    <span class="keyword">val</span> b1 = lat2 * pi /<span class="number">180.0</span></span><br><span class="line">    <span class="keyword">val</span> b2 = lon2 * pi /<span class="number">180.0</span></span><br><span class="line">    <span class="keyword">var</span> t1: <span class="type">Double</span> = <span class="type">Math</span>.cos(a1) * <span class="type">Math</span>.cos(a2) * <span class="type">Math</span>.cos(b1)* <span class="type">Math</span>.cos(b2)</span><br><span class="line">    <span class="keyword">var</span> t2: <span class="type">Double</span> = <span class="type">Math</span>.cos(a1) * <span class="type">Math</span>.sin(a2) * <span class="type">Math</span>.cos(b1)* <span class="type">Math</span>.sin(b2)</span><br><span class="line">    <span class="keyword">var</span> t3: <span class="type">Double</span> = <span class="type">Math</span>.sin(a1) * <span class="type">Math</span>.sin(b1)</span><br><span class="line">    <span class="keyword">val</span> distance = <span class="type">Math</span>.acos(t1 + t2 + t3) * r</span><br><span class="line">    distance * <span class="number">1000</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Exiting paste mode, now interpreting.</span></span><br><span class="line"></span><br><span class="line">calDistanceM: (lon1: <span class="type">Double</span>, lat1: <span class="type">Double</span>, lon2: <span class="type">Double</span>, lat2: <span class="type">Double</span>)<span class="type">Double</span></span><br><span class="line"></span><br><span class="line">scala&gt; calDistanceM(<span class="number">121.337293282</span>, <span class="number">31.1672401193</span>, <span class="number">121.366448159</span>, <span class="number">31.2103586192</span>)</span><br><span class="line">res0: <span class="type">Double</span> = <span class="number">5538.864157826987</span></span><br><span class="line"></span><br><span class="line">scala&gt; calDistanceM(<span class="number">121.337293282</span>, <span class="number">31.1672401193</span>, <span class="number">121.337393282</span>, <span class="number">31.1673401193</span>)</span><br><span class="line">res1: <span class="type">Double</span> = <span class="number">14.634816191814881</span></span><br></pre></td></tr></table></figure>
<h3 id="Bottleneck"><a href="#Bottleneck" class="headerlink" title="Bottleneck"></a>Bottleneck</h3><p>I use <code>m3.medium</code> for Spark Master/Workers, and <code>m4.4xlarge</code> for PostGIS server, and the instance count ratio is <em>20:1</em>.<br>For my typical jobs, the CPU usage is ~50%, and seems the bottleneck is the networking, before I start the optimization of the pipeline.</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><em>from Spark official docs, Stackoverflow and other web resources…</em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://hiack.com/2018/01/27/201801/bad-idea-using-spark-with-s3-md/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CJ's SpaceX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/27/201801/bad-idea-using-spark-with-s3-md/" itemprop="url">Bad Idea Using SparkSQL with S3</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-27T23:23:24+08:00">
                2018-01-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/spark/" itemprop="url" rel="index">
                    <span itemprop="name">Spark</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/spark/aws-s3/" itemprop="url" rel="index">
                    <span itemprop="name">AWS S3</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>In my recent project <a href="http://hiack.com/2018/01/21/audience_geo_analysis_using_spark_postgis/">Audience Geo Analysis using Spark + PostGis</a>, I use <strong>AWS S3</strong> as the source &amp; destination data store.<br>Although, </p>
<ul>
<li>I’m aware that AWS S3 is <strong>an object store but not a true file system</strong>, and,</li>
<li>I’ve heard of that the AWS S3 <strong>consistency model</strong> may cause some problem to Spark (or other similar big data applications), and</li>
<li>I configured my app specifically for this, as:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spark.hadoop.mapreduce.fileoutputcommitter.algorithm.version 2</span><br><span class="line">spark.speculation false</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Yet I got a punch in my face.</p>
<p>The <strong>background</strong> is, I need to create 2 tables from large log data and perform a join operation on them.<br>In case any of them fails and I don’t want to waste time in re-running the full pipeline, I submitted 3 jobs separately in sequence: I put the 3 <code>spark-submit</code> in a shell script and ran it in background, and then I went to sleep.  </p>
<p>The final <code>join</code> job looks like:<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; df1.orderBy(<span class="string">"uid"</span>).show</span><br><span class="line"></span><br><span class="line">+----+----+---+</span><br><span class="line">| uid| hid| sv|</span><br><span class="line">+----+----+---+</span><br><span class="line">|uid1|hid2| <span class="number">10</span>|</span><br><span class="line">|uid1|hid1| <span class="number">10</span>|</span><br><span class="line">|uid1|hid3| <span class="number">10</span>|</span><br><span class="line">|uid2|hid1|  <span class="number">2</span>|</span><br><span class="line">|uid3|hid2| <span class="number">10</span>|</span><br><span class="line">|uid4|hid2|  <span class="number">3</span>|</span><br><span class="line">|uid5|hid3|  <span class="number">5</span>|</span><br><span class="line">+----+----+---+</span><br><span class="line"></span><br><span class="line">scala&gt; df2.orderBy(<span class="string">"uid"</span>).show</span><br><span class="line"></span><br><span class="line">+----+----+---+</span><br><span class="line">| uid| pid| sv|</span><br><span class="line">+----+----+---+</span><br><span class="line">|uid1|pid2|  <span class="number">2</span>|</span><br><span class="line">|uid1|pid1|  <span class="number">1</span>|</span><br><span class="line">|uid2|pid1|  <span class="number">2</span>|</span><br><span class="line">|uid3|pid1|  <span class="number">3</span>|</span><br><span class="line">|uid3|pidx|<span class="number">999</span>|</span><br><span class="line">|uid3|pid2|  <span class="number">4</span>|</span><br><span class="line">|uidx|pid1|  <span class="number">2</span>|</span><br><span class="line">+----+----+---+</span><br><span class="line"></span><br><span class="line">scala&gt; df1.drop(<span class="string">"sv"</span>)</span><br><span class="line">  .join(df2, <span class="string">"uid"</span>)</span><br><span class="line">  .groupBy(<span class="string">"hid"</span>, <span class="string">"pid"</span>)</span><br><span class="line">  .agg(count(<span class="string">"*"</span>) as <span class="string">"xcnt"</span>, sum(<span class="string">"sv"</span>) as <span class="string">"xsum"</span>, avg(<span class="string">"sv"</span>) as <span class="string">"xavg"</span>)</span><br><span class="line">  .orderBy(<span class="string">"hid"</span>).show</span><br><span class="line"></span><br><span class="line">+----+----+----+----+-----+</span><br><span class="line">| hid| pid|xcnt|xsum| xavg|</span><br><span class="line">+----+----+----+----+-----+</span><br><span class="line">|hid1|pid1|   <span class="number">2</span>|   <span class="number">3</span>|  <span class="number">1.5</span>|</span><br><span class="line">|hid1|pid2|   <span class="number">1</span>|   <span class="number">2</span>|  <span class="number">2.0</span>|</span><br><span class="line">|hid2|pid2|   <span class="number">2</span>|   <span class="number">6</span>|  <span class="number">3.0</span>|</span><br><span class="line">|hid2|pidx|   <span class="number">1</span>| <span class="number">999</span>|<span class="number">999.0</span>|</span><br><span class="line">|hid2|pid1|   <span class="number">2</span>|   <span class="number">4</span>|  <span class="number">2.0</span>|</span><br><span class="line">|hid3|pid1|   <span class="number">1</span>|   <span class="number">1</span>|  <span class="number">1.0</span>|</span><br><span class="line">|hid3|pid2|   <span class="number">1</span>|   <span class="number">2</span>|  <span class="number">2.0</span>|</span><br><span class="line">+----+----+----+----+-----+</span><br></pre></td></tr></table></figure></p>
<p>When I checked the final result today, I was so surprised there were <strong>duplicate <code>(hid, pid)</code> rows</strong> in it.  </p>
<p>At first, I thought I was mis-using the SparkSQL operators, and spent much time debugging it. But when I tried to reproduce it in Spark-Shell. everything was just fine.   </p>
<p>Finnaly, I realized, <strong><em>probably</em></strong>, the root cause is AWS S3 consistency model.<br>I’m not totally sure of it, but got no other choice.  </p>
<p>So, the workaround is,</p>
<ul>
<li>Put the 3 jobs in a single Spark app, or</li>
<li>Run the dependent down-stream job (like the final join job) later for a while.</li>
</ul>
<p>I haven’t verified them both, but at least the 2nd works for me.</p>
<p>The lesson is, <strong>if you have another choice like HDFS, you’d better just pass AWS S3 as the intermediate big data storage</strong>.</p>
<p><strong><em>[Update]</em></strong></p>
<ul>
<li>I’m almost sure it’s the AWS S3’s problem now.</li>
<li>As last time when I copied the result data from S3 to local host, soon after the job was done, the downloaded data contained some records not supposed to be there.</li>
<li>But when I re-downloaded the same bucket from S3, the data turned to be correct.</li>
<li>So what else could it be?</li>
</ul>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/Introduction.html#ConsistencyModel" target="_blank" rel="noopener">Amazon S3 Data Consistency Model</a></li>
<li><a href="https://medium.com/@subhojit20_27731/apache-spark-and-amazon-s3-gotchas-and-best-practices-a767242f3d98" target="_blank" rel="noopener">Apache Spark and Amazon S3 — Gotchas and best practices</a><br>-<a href="https://hortonworks.com/blog/s3guard-amazon-s3-consistency/" target="_blank" rel="noopener">USING S3GUARD FOR AMAZON S3 CONSISTENCY</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://hiack.com/2018/01/24/201801/window-frame-in-postgresl-spark/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CJ's SpaceX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/24/201801/window-frame-in-postgresl-spark/" itemprop="url">Window Frame in PostgreSQL and SparkSQL</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-24T13:40:35+08:00">
                2018-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/spark/" itemprop="url" rel="index">
                    <span itemprop="name">Spark</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/spark/postgresql/" itemprop="url" rel="index">
                    <span itemprop="name">PostgreSql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>I need to select the top row out of each <em>row group (row window)</em> partitioned by some rule, from a PostgreSql and SparkSQl table, that’s what <strong>Window Frame</strong> is about.<br>Just copy some examples from other articles/docs (as listed in the <em>Reference</em> Section) to show the concept and related operations of <strong>Window Frame</strong> and <strong>Window Functions</strong>, in PostgreSql.<br>Stackoverflow has plenty of examples showing the use in SparkSQL.   </p>
<h1 id="Concept-amp-Operations-in-PostgreSQL"><a href="#Concept-amp-Operations-in-PostgreSQL" class="headerlink" title="Concept &amp; Operations in PostgreSQL"></a>Concept &amp; Operations in PostgreSQL</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">postgres=# select * from empsal ;</span><br><span class="line">  depname  | empno | salary</span><br><span class="line"><span class="comment">-----------+-------+--------</span></span><br><span class="line"> develop   |    11 |   5200</span><br><span class="line"> develop   |     7 |   4200</span><br><span class="line"> develop   |     9 |   4500</span><br><span class="line"> develop   |     8 |   6000</span><br><span class="line"> develop   |    10 |   5200</span><br><span class="line"> personnel |     5 |   3500</span><br><span class="line"> personnel |     2 |   3900</span><br><span class="line"> sales     |     3 |   4800</span><br><span class="line"> sales     |     1 |   5000</span><br><span class="line"> sales     |     4 |   4800</span><br><span class="line">(10 rows)</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">postgres=# SELECT depname, empno, salary, avg(salary) OVER (PARTITION BY depname) FROM empsal;</span><br><span class="line">  depname  | empno | salary |          avg          </span><br><span class="line"><span class="comment">-----------+-------+--------+-----------------------</span></span><br><span class="line"> develop   |    11 |   5200 | 5020.0000000000000000</span><br><span class="line"> develop   |     7 |   4200 | 5020.0000000000000000</span><br><span class="line"> develop   |     9 |   4500 | 5020.0000000000000000</span><br><span class="line"> develop   |     8 |   6000 | 5020.0000000000000000</span><br><span class="line"> develop   |    10 |   5200 | 5020.0000000000000000</span><br><span class="line"> personnel |     5 |   3500 | 3700.0000000000000000</span><br><span class="line"> personnel |     2 |   3900 | 3700.0000000000000000</span><br><span class="line"> sales     |     3 |   4800 | 4866.6666666666666667</span><br><span class="line"> sales     |     1 |   5000 | 4866.6666666666666667</span><br><span class="line"> sales     |     4 |   4800 | 4866.6666666666666667</span><br><span class="line">(10 rows)</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">postgres=# SELECT depname, empno, salary, rank() OVER (PARTITION BY depname ORDER BY salary DESC) FROM empsal;</span><br><span class="line">  depname  | empno | salary | rank </span><br><span class="line"><span class="comment">-----------+-------+--------+------</span></span><br><span class="line"> develop   |     8 |   6000 |    1</span><br><span class="line"> develop   |    10 |   5200 |    2</span><br><span class="line"> develop   |    11 |   5200 |    2</span><br><span class="line"> develop   |     9 |   4500 |    4</span><br><span class="line"> develop   |     7 |   4200 |    5</span><br><span class="line"> personnel |     2 |   3900 |    1</span><br><span class="line"> personnel |     5 |   3500 |    2</span><br><span class="line"> sales     |     1 |   5000 |    1</span><br><span class="line"> sales     |     3 |   4800 |    2</span><br><span class="line"> sales     |     4 |   4800 |    2</span><br><span class="line">(10 rows)</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> depname, empno, salary</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">  (<span class="keyword">SELECT</span> depname, empno, salary,</span><br><span class="line">          <span class="keyword">rank</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> depname <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>, empno) <span class="keyword">AS</span> pos</span><br><span class="line">     <span class="keyword">FROM</span> empsal</span><br><span class="line">  ) <span class="keyword">AS</span> ss</span><br><span class="line"><span class="keyword">WHERE</span> pos &lt; <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">postgres=# SELECT depname, empno, salary</span><br><span class="line">postgres-# FROM</span><br><span class="line">postgres-#   (SELECT depname, empno, salary,</span><br><span class="line">postgres(#           rank() OVER (PARTITION BY depname ORDER BY salary DESC, empno) AS pos</span><br><span class="line">postgres(#      FROM empsal</span><br><span class="line">postgres(#   ) AS ss</span><br><span class="line">postgres-# WHERE pos &lt; 3;</span><br><span class="line">  depname  | empno | salary </span><br><span class="line"><span class="comment">-----------+-------+--------</span></span><br><span class="line"> develop   |     8 |   6000</span><br><span class="line"> develop   |    10 |   5200</span><br><span class="line"> personnel |     2 |   3900</span><br><span class="line"> personnel |     5 |   3500</span><br><span class="line"> sales     |     1 |   5000</span><br><span class="line"> sales     |     3 |   4800</span><br><span class="line">(6 rows)</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">sum</span>(salary) <span class="keyword">OVER</span> w, <span class="keyword">avg</span>(salary) <span class="keyword">OVER</span> w</span><br><span class="line">  <span class="keyword">FROM</span> empsal</span><br><span class="line">  WINDOW w <span class="keyword">AS</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> depname <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>);</span><br><span class="line"></span><br><span class="line">postgres=# SELECT sum(salary) OVER w, avg(salary) OVER w</span><br><span class="line">postgres-#   FROM empsal</span><br><span class="line">postgres-#   WINDOW w AS (PARTITION BY depname ORDER BY salary DESC);</span><br><span class="line">  sum  |          avg          </span><br><span class="line"><span class="comment">-------+-----------------------</span></span><br><span class="line">  6000 | 6000.0000000000000000</span><br><span class="line"> 16400 | 5466.6666666666666667</span><br><span class="line"> 16400 | 5466.6666666666666667</span><br><span class="line"> 20900 | 5225.0000000000000000</span><br><span class="line"> 25100 | 5020.0000000000000000</span><br><span class="line">  3900 | 3900.0000000000000000</span><br><span class="line">  7400 | 3700.0000000000000000</span><br><span class="line">  5000 | 5000.0000000000000000</span><br><span class="line"> 14600 | 4866.6666666666666667</span><br><span class="line"> 14600 | 4866.6666666666666667</span><br><span class="line">(10 rows)</span><br></pre></td></tr></table></figure>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://www.postgresql.org/docs/10/static/tutorial-window.html" target="_blank" rel="noopener">Window Functions</a><br><a href="http://time-track.cn/postgresql-window-function.html" target="_blank" rel="noopener">PostgreSQL窗口函数</a><br><a href="https://stackoverflow.com/questions/33878370/how-to-select-the-first-row-of-each-group" target="_blank" rel="noopener">How to select the first row of each group?</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://hiack.com/2018/01/23/201801/use-overridable-in-constructor-in-cpp-java-scala-md/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CJ's SpaceX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/23/201801/use-overridable-in-constructor-in-cpp-java-scala-md/" itemprop="url">Use Overridable in Constructor in C++, Java and Scala</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-23T14:18:28+08:00">
                2018-01-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/c/" itemprop="url" rel="index">
                    <span itemprop="name">C++</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/c/scala/" itemprop="url" rel="index">
                    <span itemprop="name">Scala</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/c/scala/java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>So we all know that in object-oriented programming, the use of overridable constructs like virtual functions or overridable variables (in Scala) in <strong>Constructor</strong> must be avoided, or at least be carefully examined.<br>But if you insist to referencing the overridable in constructors,  there’re some subtile distinctions between C++ and Java (as well as Scala) you’d better know of.</p>
<p>As mentioned by <code>Scala for the Impatient (2nd. Edition)</code> in <code>Chapter 8</code>:  </p>
<blockquote>
<p>NOTE: At the root of the construction order problem lies a design decision of the Java language - namely, to allow the invocation of subclass methods in a superclass constructor.<br>In C++, an object’s virtual function table pointer is set to the table of the superclass when the superclass constructor executes. Afterwards, the pointer is set to the subclass table. Therefore, in C++, it is not possible to modify constructor behavior through overriding.<br>The Java designers felt that this subtlety was unnecessary, and the Java virtual machine does not adjust the virtual function table during construction.</p>
</blockquote>
<p>To put it straight, if you call an overridable method in the base class constructor, which is overridden in the subclass, the resulting call goes to:  </p>
<ul>
<li><strong>in C++: the base class method</strong><br> actually this means the virtual function doesn’t work at all in the constructor</li>
<li><p><strong>in Java/Scala: the sub class method</strong><br> and if the sub class method references some member variables defined in sub class, it could be a problem as the subclass members are not initialized yet.</p>
</li>
<li><p><strong>C++</strong>  </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Base() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Base::Constructing "</span> + name() + <span class="string">"..."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>; ; &#125;</span><br><span class="line">    <span class="keyword">virtual</span> ~Base() &#123;&#125;</span><br><span class="line">    <span class="keyword">virtual</span> <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">name</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"Base"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Derived</span>:</span> <span class="keyword">public</span> Base &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Derived(): Base(), nickname(<span class="string">"Subclass"</span>) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Derived::Constructing "</span> + name() + <span class="string">"..."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>; &#125;</span><br><span class="line">    <span class="keyword">virtual</span> <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">name</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"Derived/"</span> + nickname; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> nickname;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Base* b = <span class="keyword">new</span> Derived();</span><br><span class="line">    (<span class="keyword">void</span>)b;</span><br><span class="line">    <span class="comment">/* Output:</span></span><br><span class="line"><span class="comment">       Base::Constructing Base...</span></span><br><span class="line"><span class="comment">       Derived::Constructing Derived/Subclass...</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Java</strong>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj;</span><br><span class="line"></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line">    Base() &#123;</span><br><span class="line">        System.out.println(<span class="string">"Base::Constructing "</span> + name() + <span class="string">"..."</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"Base"</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Derived</span> <span class="keyword">extends</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line">    Derived() &#123;</span><br><span class="line">        nickname = <span class="string">"Subclsass"</span>;</span><br><span class="line">        System.out.println(<span class="string">"Derived::Constructing "</span> + name() + <span class="string">"..."</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"Derived"</span> + <span class="string">"/"</span> + nickname; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String nickname;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Derived();</span><br><span class="line">        <span class="comment">/* Output</span></span><br><span class="line"><span class="comment">            Base::Constructing Derived/null...</span></span><br><span class="line"><span class="comment">            Derived::Constructing Derived/Subclsass...</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Scala</strong>  </p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Creature</span>  </span>&#123;</span><br><span class="line">  <span class="keyword">val</span> range: <span class="type">Int</span> = <span class="number">10</span></span><br><span class="line">  <span class="keyword">val</span> env: <span class="type">Array</span>[<span class="type">Int</span>] = <span class="keyword">new</span> <span class="type">Array</span>[<span class="type">Int</span>](range)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ant</span> <span class="keyword">extends</span> <span class="title">Creature</span> </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="keyword">val</span> range = <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Ant</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>() = <span class="keyword">new</span> <span class="type">Ant</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Main</span> <span class="keyword">extends</span> <span class="title">App</span> </span>&#123;</span><br><span class="line">  <span class="keyword">val</span> ant = <span class="type">Ant</span>()</span><br><span class="line">  <span class="type">System</span>.out.println(<span class="string">s"Ant.env.length = <span class="subst">$&#123;ant.env.length&#125;</span>"</span>)</span><br><span class="line">  <span class="type">System</span>.out.println(<span class="string">s"Ant.range = <span class="subst">$&#123;ant.range&#125;</span>"</span>)</span><br><span class="line">  <span class="comment">/* Output:</span></span><br><span class="line"><span class="comment">      Ant.env.length = 0</span></span><br><span class="line"><span class="comment">      Ant.range = 2</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://hiack.com/2018/01/19/201801/cut_csv_in_dos/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CJ's SpaceX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/19/201801/cut_csv_in_dos/" itemprop="url">Weird Result when Cut CSV Files in DOS Format</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-19T18:08:56+08:00">
                2018-01-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/shell/" itemprop="url" rel="index">
                    <span itemprop="name">Shell</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>It happened again.<br>So maybe I should put it down here.  </p>
<p>I converted a Mac Numbers file to CSV file (whose columns were copied from an Excel file), and the file looks like this in Vim:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[cj ~/Downloads]$ head  xxx.csv</span><br><span class="line">31.19294,121.44045</span><br><span class="line">31.23328,121.47479</span><br><span class="line">31.27414,121.45309</span><br><span class="line">31.19335,121.43978</span><br><span class="line">31.23511,121.49741</span><br></pre></td></tr></table></figure></p>
<p>But, when you cut it, the output looks like this:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[cj ~/Downloads]$ awk -F<span class="string">','</span> <span class="string">'&#123;OFS=","; print "["$2,$1"],"&#125;'</span> xxx.csv | head</span><br><span class="line">,31.19294],</span><br><span class="line">,31.23328],</span><br><span class="line">,31.27414],</span><br><span class="line">,31.19335],</span><br><span class="line">,31.23511],</span><br></pre></td></tr></table></figure></p>
<p>If you open the file with Vim, you may notice the hint at the bottom: <code>&quot;xxx.csv&quot; [dos] 587L, 11616C</code>.<br>And you just check the file in hex format in Vim, by: <code>:%!xxd</code>, you will find the root cause:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">00000000: 3331 2e31 3932 3934 2c31 3231 2e34 3430  31.19294,121.440</span><br><span class="line">00000010: 3435 0d0a 3331 2e32 3333 3238 2c31 3231  45..31.23328,121</span><br></pre></td></tr></table></figure></p>
<p>Note the <code>0d0a</code>.  </p>
<p>In Unix format, it looks like:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">00000000: 3331 2e31 3932 3934 2c31 3231 2e34 3430  31.19294,121.440</span><br><span class="line">00000010: 3435 0a33 312e 3233 3332 382c 3132 312e  45.31.23328,121.</span><br><span class="line">00000020: 3437 3437 390a                           47479.</span><br></pre></td></tr></table></figure></p>
<p>Just <code>0a</code>.  </p>
<p>So, you just need to <code>dos2unix xxx.csv</code> (<code>brew install dos2unix1</code> if it’s absent).  </p>
<p>And, a note irrelevant to this topic:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -n <span class="string">'/18\/01\/17 10:49/,/18\/01\/17 10:55/p'</span> some-service.log</span><br></pre></td></tr></table></figure></p>
<p>, to filter for logs within the date/time range.  </p>
<p>When I was working in the giant internet company, I used to use this command to check for error logs happened within some time window to debug online issue.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://hiack.com/2018/01/11/201801/enable_public_host_name_in_spark_webui/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CJ's SpaceX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/11/201801/enable_public_host_name_in_spark_webui/" itemprop="url">Enable Public Host Name in Spark Web UI</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-11T18:08:56+08:00">
                2018-01-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/spark/" itemprop="url" rel="index">
                    <span itemprop="name">Spark</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>My Spark cluster (standalone) setup in AWS EC2 is assuming internal IP addresses in the WebUI (by default) for links to Master and Workers, and thus I cannot go freely among them.</p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><pre><code class="bash"><span class="keyword">for</span> h <span class="keyword">in</span> $(cat slaves)
<span class="keyword">do</span>
  ssh &lt;user&gt;@<span class="variable">$h</span> <span class="string">"sudo sh -c \"echo export SPARK_PUBLIC_DNS=<span class="variable">$h</span> &gt;&gt; /path/to/spark/conf/spark-env.sh\""</span>
<span class="keyword">done</span>
</code></pre>
<p>Don’t forget the master server.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://hiack.com/2018/01/11/201801/redirect_with_sudo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CJ's SpaceX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/11/201801/redirect_with_sudo/" itemprop="url">Permission Denied when sudo with io redirect</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-11T15:08:56+08:00">
                2018-01-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/shell/" itemprop="url" rel="index">
                    <span itemprop="name">Shell</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p><code>ssh user1@somehost &quot;sudo echo &gt;&gt; /home/user2/xxx&quot;</code> will result in <code>Permission denied</code>.</p>
<p>The root cause is the redirection is performed by the login shell, which does not have the permission.<br>The redirection of the output is <strong>not</strong> performed by sudo.  </p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ul>
<li>Run a shell with sudo and give the command to it by using the <code>-c</code> option:<br><code>sudo sh -c &#39;ls -hal /root/ &gt; /root/test.out&#39;</code></li>
<li><p>Create a script with your commands and run that script with sudo:  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">ls -hal /root/ &gt; /root/test.out</span><br></pre></td></tr></table></figure>
<p>or  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo bash &lt;&lt;EOF</span><br><span class="line">ls -hal /root/ &gt; /root/test.out</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>or  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'ls -hal /root/ &gt; /root/test.out'</span> | sudo bash</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>For more, refer to <a href="https://stackoverflow.com/questions/82256/how-do-i-use-sudo-to-redirect-output-to-a-location-i-dont-have-permission-to-wr/16514624#16514624" target="_blank" rel="noopener">StackOverflow</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://hiack.com/2018/01/10/201801/enable_spark_on_ec2_accessing_s3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CJ's SpaceX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/10/201801/enable_spark_on_ec2_accessing_s3/" itemprop="url">Enable Spark on AWS EC2 Accessing AWS S3</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-10T18:08:56+08:00">
                2018-01-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/spark/" itemprop="url" rel="index">
                    <span itemprop="name">Spark</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/spark/devops/" itemprop="url" rel="index">
                    <span itemprop="name">DevOps</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>I setup a Spark Standalone cluster on AWS EC2 (region: cn-north-1).<br>And I build a Simple Spark application in Scala, which reads from and writes to AWS S3.<br>Regarding the <code>SecurityException</code> issue, refer to <a href="http://hiack.com/2018/01/15/spark_class_not_found/">ClassNotFoundException/SecurityException in Spark+sbt</a>.  </p>
<p>To enable Spark accessing AWS S3, some config must be taken care of, including:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">--deploy-mode client \</span><br><span class="line">--driver-memory 2400m \</span><br><span class="line">--executor-memory 2400m \</span><br><span class="line">--conf spark.executor.extraJavaOptions=-Dcom.amazonaws.services.s3.enableV4=<span class="literal">true</span> \</span><br><span class="line">--conf spark.driver.extraJavaOptions=-Dcom.amazonaws.services.s3.enableV4=<span class="literal">true</span> \</span><br><span class="line">--conf spark.hadoop.mapreduce.fileoutputcommitter.algorithm.version=2 \</span><br><span class="line">--conf spark.speculation=<span class="literal">false</span> \</span><br><span class="line">--conf spark.hadoop.fs.s3a.region=cn-north-1 \</span><br><span class="line">--conf spark.hadoop.fs.s3a.impl=org.apache.hadoop.fs.s3a.S3AFileSystem \</span><br><span class="line">--conf spark.hadoop.fs.s3a.endpoint=s3.cn-north-1.amazonaws.com.cn \</span><br><span class="line">--conf spark.hadoop.fs.s3a.access.key=******************** \</span><br><span class="line">--conf spark.hadoop.fs.s3a.secret.key=**************************************** \</span><br></pre></td></tr></table></figure></p>
<p>If you want to hard code them in the source code:<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sc.hadoopConfiguration.set(<span class="string">"fs.s3a.endpoint"</span>, <span class="string">"s3.cn-north-1.amazonaws.com.cn"</span>)</span><br><span class="line">sc.hadoopConfiguration.set(<span class="string">"fs.s3a.impl"</span>, <span class="string">"org.apache.hadoop.fs.s3a.S3AFileSystem"</span>)</span><br><span class="line">sc.hadoopConfiguration.set(<span class="string">"fs.s3a.region"</span>, <span class="string">"cn-north-1"</span>)</span><br><span class="line"><span class="comment">//sc.hadoopConfiguration.set("fs.s3a.awsAccessKeyId", "********************")</span></span><br><span class="line"><span class="comment">//sc.hadoopConfiguration.set("fs.s3a.awsSecretAccessKey", "****************************************")</span></span><br><span class="line">sc.hadoopConfiguration.set(<span class="string">"fs.s3a.access.key"</span>, <span class="string">"********************"</span>)</span><br><span class="line">sc.hadoopConfiguration.set(<span class="string">"fs.s3a.secret.key"</span>, <span class="string">"****************************************"</span>)</span><br></pre></td></tr></table></figure></p>
<p>Or, set them in the <code>spark-env.sh</code>.  </p>
<p>I haven’t made it work in the cluster mode, without mannually coping the jars to the cluster nodes.</p>
<p><strong>Note:</strong>  </p>
<ul>
<li>There’re several ways AWS keys being captured by Spark, like spark-submit config, Spark/bash env, ~/.aws/credentials, etc. Just try it.</li>
<li>If the input/output args to your Spark application are S3 paths, you might need to specify the paths with schema <strong><code>s3a://...</code></strong></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://hiack.com/2018/01/03/201801/spark_class_not_found/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CJ's SpaceX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/201801/spark_class_not_found/" itemprop="url">ClassNotFoundException/SecurityException in Spark+sbt</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-03T18:08:56+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/spark/" itemprop="url" rel="index">
                    <span itemprop="name">Spark</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>I tried to run a simple Spark application using <strong>IntelliJ+sbt</strong>, but things never went as you wished.<br>I always got the same error message when I tried to submit the app to the Spark cluster: <code>java.lang.ClassNotFoundException</code>.   </p>
<p>I tried to change the package name, project structure, etc., but didn’t help.   </p>
<p>Finally, when I tried to run the app in Spark local, the error message changed to<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.SecurityException: Invalid signature file digest for Manifest main attributes</span><br></pre></td></tr></table></figure></p>
<p>Then googled it. As a common problem, the workaround is:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zip -d &lt;your&gt;.jar &apos;META-INF/.SF&apos; &apos;META-INF/.RSA&apos; &apos;META-INF/*SF&apos;</span><br></pre></td></tr></table></figure></p>
<p>This workaround should be combined into sbt, but I don’t want to stop for it at the moment.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://hiack.com/2018/01/02/201801/inside_map_reduce/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CJ's SpaceX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/02/201801/inside_map_reduce/" itemprop="url">Inside MapReduce (Spill, Shuffle and Sort)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-02T18:08:56+08:00">
                2018-01-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/" itemprop="url" rel="index">
                    <span itemprop="name">Hadoop</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h1><p>I don’t read the source code.<br>Just read some docs and have my personal understanding regarding the details of MapReduce (Version: ~hadoop 2.x).<br>So correct me if I’m wrong.<br>Some numbers below are just typical values, as well as the property names, and they could vary for different versions or due to user settings.</p>
<p><img src="/content/images/2018/01/mapreduce.png" alt="MapReduce"><br><em>I copied this image from the web (tell me if the author doesn’t want me to do this).</em></p>
<h1 id="Map-Side"><a href="#Map-Side" class="headerlink" title="Map Side"></a>Map Side</h1><ul>
<li><strong>InputSplit</strong>   <ul>
<li>For each inputsplit, MR spawns a Map task.</li>
<li>The FileSystem blocksize of the input files is treated as an upper bound for input splits (<em>mapreduce.input.fileinputformat.split.minsize</em>).</li>
<li>The default InputSplit size is as an HDFS block, I think. But this could be set by <em>mapreduce.map.input.length</em>.   </li>
</ul>
</li>
<li><strong>Circular Buffer</strong>   <ul>
<li>The Map output does not go directly to the disk, but a circular memoery buffer.</li>
<li>100MB by default; can be changed by <em>mapreduce.task.io.sort.mb</em>.</li>
<li>When the content of the buffer reaches some threadhold (<em>mapreduce.map.sort.spill.percent</em>, 80% by default), a <strong>spill</strong> will be triggered. (if a map output record is larger than the buffer, it will also trigger a spill).</li>
</ul>
</li>
<li><strong>Spill</strong>   <ul>
<li>A new thread will be started to spill the buffer records to local disk, in parallel with the mapper, if possible.</li>
<li>The <strong>spill</strong> stage includes <strong>Partition, Sort and Combine</strong>.</li>
<li><strong>Partition, Sort and Combine</strong><ul>
<li>As map outputs are spilled onto local disk, the piece of data (like 80MB) will be paritioned per reducers (typicall, hash &amp; mod), sorted in memory, and combined if enabled (mini-reduce).</li>
</ul>
</li>
<li>Each spill will create a new file on local disk.</li>
<li>So after the map task has written its last output record, there could be several spill files.</li>
<li>Before the map task is finished and its output is feteched by Reducer, the spill files will be merged into a single partitioned and sorted output file.<ul>
<li>The property <strong><em>io.sort.factor</em></strong> will tell the maximum numbers of spill files  that can be merge in one go, which is also used in Reduer Merge Sort. </li>
<li>It’s said that if there’re 3+ spill files, combiner will be applied again during the creation of the final map output file.</li>
</ul>
</li>
<li>If <strong>compression</strong> is enabled, before the final map output is written onto disk, the map output will be compressed (and uncompressed in the Reducer side).</li>
<li>Now, the map output is a single sorted, partitioned, compact local file, which is ready to be fetched by Reducers via HTTP.<ul>
<li><strong>Why HTTP?</strong> Because it’s a local file, not HDFS blocks.</li>
<li>And that’s why if the cluster node failes, all Mapper tasks succeeded on it previously must be re-run, no matter if their outputs are fetched by Reducers, while all succeeded Reducers tasks don’t need.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="Reduce-Side"><a href="#Reduce-Side" class="headerlink" title="Reduce Side"></a>Reduce Side</h1><p>The Reduce stage consists of <strong>Shuffle, Sort (also called Merge) and Reduce</strong>.</p>
<ul>
<li><strong>Shuffle</strong><ul>
<li>Shuffling is the process of copying mapper outpus to reducers.</li>
<li>When does shuffle start?<ul>
<li>This can happen while mappers are generating data since it is only a data transfer.</li>
<li>On the other hand, sort and reduce can only start once all the mappers are done.</li>
<li>You can tell which one MapReduce is doing by looking at the reducer completion percentage:<ul>
<li>0-33% means its doing shuffle,</li>
<li>34-66% is sort,</li>
<li>67%-100% is reduce.</li>
</ul>
</li>
<li>This is why your reducers will sometimes seem “stuck” at 33%– it’s waiting for mappers to finish.</li>
</ul>
</li>
<li>So, when, exactly?<ul>
<li>Reducers start shuffling based on a threshold of percentage of mappers that have finished (<em>mapreduce.job.reduce.slowstart.completedmap</em>）.</li>
</ul>
</li>
<li>Reducers starts several threads (5 by default) to fetch mapper outputs in parallel.</li>
<li>The map outputs are copied to the reduce task JVM’s memory if they are small enough (<em>mapred.job.shuffle.input.buffer.percent</em>); otherwise they are copied to disk .</li>
</ul>
</li>
<li><strong>Merge/Sort</strong><ul>
<li>When all the map outputs have been copied, the reduce task moves into the <strong>sort</strong> phase (actually <strong>merge sort</strong>), which merges the map outputs, maintaining their sort ordering.</li>
<li>This is done in rounds.</li>
<li>For example,<ul>
<li>if there were 50 map outputs and the merge factor was 10 (<strong><em>io.sort.factor</em>, just like in the map’s merge</strong>), there would be 5 rounds.</li>
<li>Each round would merge 10 files into one, so at the end there would be 5 intermediate files.</li>
<li>Rather than have a final round that merges these 5 files into a single sorted file, the merge saves a trip to disk by directly feeding the reduce function in what is the last phase: the reduce phase.</li>
<li>This final merge can come from a mixture of in-memory and on-disk segments, as the last merge round could keep some data in memroy and then start the final reduce job (<strong><em>mapreduce.reduce.input.buffer.percent</em></strong>).</li>
</ul>
</li>
</ul>
</li>
<li><strong>Reduce</strong><ul>
<li>During the reduce phase, the reduce function is invoked for each key in the sorted output.</li>
<li>The output of this phase is written directly to the output filesystem, typically HDFS, in which case the first block replica will generally be written to the local disk managed by the datanode.</li>
</ul>
</li>
</ul>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://hadoop.apache.org/docs/stable/hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapReduceTutorial.html" target="_blank" rel="noopener">MapReduce Tutorial</a><br><a href="https://developer.yahoo.com/hadoop/tutorial/module4.html" target="_blank" rel="noopener">Module 4: MapReduce</a><br><a href="http://dailyhadoopsoup.blogspot.com/2014/01/shuffle-and-sort.html" target="_blank" rel="noopener">http://dailyhadoopsoup.blogspot.hk/2014/01/shuffle-and-sort.html</a><br><a href="https://haritbigdata.wordpress.com/2015/07/21/hadoop-inside-mapreduce-process-of-shuffling-sorting-part-ii/" target="_blank" rel="noopener">Hadoop :- Inside MapReduce ( Process of Shuffling , sorting ) – Part II</a><br><a href="https://stackoverflow.com/questions/11672676/when-do-reduce-tasks-start-in-hadoop" target="_blank" rel="noopener">When do reduce tasks start in Hadoop?</a><br><a href="https://stackoverflow.com/questions/22141631/what-is-the-purpose-of-shuffling-and-sorting-phase-in-the-reducer-in-map-reduce" target="_blank" rel="noopener">What is the purpose of shuffling and sorting phase in the reducer in Map Reduce Programming?</a><br><a href="https://www.youtube.com/watch?v=6ehu2jEEXWE" target="_blank" rel="noopener">Shuffle and Sort in hadoop</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">CJ</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CJ</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
